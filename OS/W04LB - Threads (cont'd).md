# Operating Systems - Threads (cont'd)

> 2017/09/14
>
> Week 04, Lecture B
>
> Note: W03LB, W04LA didn't happen because of hurricane

- [Operating Systems - Threads (cont'd)](#operating-systems---threads--cont-d-)
  * [Pthreads](#pthreads)
  * [Java Threads](#java-threads)
  * [Implicit Threading](#implicit-threading)
  * [Threading Issues](#threading-issues)
    + [Fork and Exec](#fork-and-exec)
    + [Handling sync/async signals](#handling-sync-async-signals)
    + [Cancellation](#cancellation)
    + [Pools](#pools)
    + [Thread-local storage](#thread-local-storage)
    + [Scheduler Activations](#scheduler-activations)
  * [Windows Threads](#windows-threads)
  * [Linux Threads](#linux-threads)

## Pthreads

- POSIX standard for thread creation/sync
	- Spec (API), not implementation
		- Implementation done by library
	- Can be user or kernel level
- Common in UNIX

## Java Threads

- Managed by JVM
- Usually implemented by OS thread model

```java
public interface Runnable
{
	public abstract void run();
}
```

- Extends Thread class
- Implements Runnable interface

## Implicit Threading

- Threading done by compilers and libraries instead of programmers
- Examples: Thread pools, OpenMP, Grand Central Dispatch

## Threading Issues

### Fork and Exec

- `fork()` and `exec()` calls
	- Does fork duplicate the calling thread or all threads?
	- Replaces running process (includes all threads)

### Handling sync/async signals

- Used in UNIX to notify a process that an event occurred
- **Signal handler** used to process signals
	- Generated by event
	- Delivered to process
	- Either default or user-defined handler
		- Every signal has default handler run by the kernel
		- **User-defined** signal can override
- Where should signal be delivered with multi-threading?
	- To the thread which signal applies? Every thread in process? Certain threads in process? Specific thread to receive all signals for process?

### Cancellation

- Terminating **(target) thread** before completion
- Either by async (immediate) or deferred (periodic checks for scheduled cancellation, default)
	- If cancellation off, cancel order is pending until thread enables cancellation
- Handled by signals in Linux

```c
pthread_t tid;

/* create thread */
pthread.create(&tid, 0, worker, NULL);
// ...
/* cancel thread */
pthread.cancel(tid);
```

### Pools

- Create number of threads in a *pool* to wait for work
- Good because it's faster to use existing threads than create a new one and can bind threads to pool size

### Thread-local storage

- Aka **TLS**
- Allows each thread to have copy of data
- Useful with pools (when no control over thread creation)
- Not same as local variables
	- TLS visible across function calls, not just in function scope
- Like `static`
	- TLS unique to each thread

### Scheduler Activations

- Need communication to keep correct number of kernel threads per application
- Use **lightweight process (LWP)** as data structure b/w user/kernel threads

## Windows Threads

- Windows API
- One-to-one, kernel-level
- Thread contains:
	- thread id
	- register set
	- User & kernel stacks for both thread modes
	- Private data area for runtime libraries and dynamic link libraries (DLLs)
	- Aka **context** of thread
- Main data structure:
	- ETHREAD (executive block)
		- Pointer to process for thread
		- Pointer to KTHREAD
		- In kernel space
	- KTHREAD (kernel block)
		- Scheduling/sync info
		- Kernel-mode stack
		- Pointer to TEB
		- In kernel space
	- TEB (thread environment block)
		- Thread id
		- User-mode stack
		- TLS
		- In user space

![Windows Threads](https://www.cs.uic.edu/~jbell/CourseNotes/OperatingSystems/images/Chapter4/4_14_WindowsThreadStructures.jpg)

## Linux Threads

- Threads known as **tasks**
- Created via `clone()`
	- Child tasks shares address space of parent (process)
